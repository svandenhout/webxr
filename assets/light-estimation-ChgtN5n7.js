import{G as b,L,e as w,f as v,S,P as R,H as E,W as P,g as C,h as W,M as X}from"./three.module-DI-f1AAC.js";class M{static createButton(s,o={}){const t=document.createElement("button");function i(e){let h=null;async function f(d){d.addEventListener("end",g),await s.xr.setSession(d),t.textContent="STOP XR",h=d}function g(){h.removeEventListener("end",g),t.textContent="START XR",h=null}t.style.display="",t.style.cursor="pointer",t.style.left="calc(50% - 50px)",t.style.width="100px",t.textContent="START XR";const m={...o,optionalFeatures:["local-floor","bounded-floor","layers",...o.optionalFeatures||[]]};t.onmouseenter=function(){t.style.opacity="1.0"},t.onmouseleave=function(){t.style.opacity="0.5"},t.onclick=function(){h===null?navigator.xr.requestSession(e,m).then(f):(h.end(),navigator.xr.offerSession!==void 0&&navigator.xr.offerSession(e,m).then(f).catch(d=>{console.warn(d)}))},navigator.xr.offerSession!==void 0&&navigator.xr.offerSession(e,m).then(f).catch(d=>{console.warn(d)})}function n(){t.style.display="",t.style.cursor="auto",t.style.left="calc(50% - 75px)",t.style.width="150px",t.onmouseenter=null,t.onmouseleave=null,t.onclick=null}function l(){n(),t.textContent="XR NOT SUPPORTED"}function u(e){n(),console.warn("Exception when trying to call xr.isSessionSupported",e),t.textContent="XR NOT ALLOWED"}function c(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return t.id="XRButton",t.style.display="none",c(t),navigator.xr.isSessionSupported("immersive-ar").then(function(e){e?i("immersive-ar"):navigator.xr.isSessionSupported("immersive-vr").then(function(h){h?i("immersive-vr"):l()}).catch(u)}).catch(u),t;{const e=document.createElement("a");return window.isSecureContext===!1?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",c(e),e}}}class T{constructor(s,o,t,i,n){this.xrLight=s,this.renderer=o,this.lightProbe=t,this.xrWebGLBinding=null,this.estimationStartCallback=n,this.frameCallback=this.onXRFrame.bind(this);const l=o.xr.getSession();if(i&&"XRWebGLBinding"in window){const u=new v(16);s.environment=u.texture;const c=o.getContext();switch(l.preferredReflectionFormat){case"srgba8":c.getExtension("EXT_sRGB");break;case"rgba16f":c.getExtension("OES_texture_half_float");break}this.xrWebGLBinding=new XRWebGLBinding(l,c),this.lightProbe.addEventListener("reflectionchange",()=>{this.updateReflection()})}l.requestAnimationFrame(this.frameCallback)}updateReflection(){const s=this.renderer.properties.get(this.xrLight.environment);if(s){const o=this.xrWebGLBinding.getReflectionCubeMap(this.lightProbe);o&&(s.__webglTexture=o,this.xrLight.environment.needsPMREMUpdate=!0)}}onXRFrame(s,o){if(!this.xrLight)return;o.session.requestAnimationFrame(this.frameCallback);const i=o.getLightEstimate(this.lightProbe);if(i){this.xrLight.lightProbe.sh.fromArray(i.sphericalHarmonicsCoefficients),this.xrLight.lightProbe.intensity=1;const n=Math.max(1,Math.max(i.primaryLightIntensity.x,Math.max(i.primaryLightIntensity.y,i.primaryLightIntensity.z)));this.xrLight.directionalLight.color.setRGB(i.primaryLightIntensity.x/n,i.primaryLightIntensity.y/n,i.primaryLightIntensity.z/n),this.xrLight.directionalLight.intensity=n,this.xrLight.directionalLight.position.copy(i.primaryLightDirection),this.estimationStartCallback&&(this.estimationStartCallback(),this.estimationStartCallback=null)}}dispose(){this.xrLight=null,this.renderer=null,this.lightProbe=null,this.xrWebGLBinding=null}}class B extends b{constructor(s,o=!0){super(),this.lightProbe=new L,this.lightProbe.intensity=0,this.add(this.lightProbe),this.directionalLight=new w,this.directionalLight.intensity=0,this.add(this.directionalLight),this.environment=null;let t=null,i=!1;s.xr.addEventListener("sessionstart",()=>{const n=s.xr.getSession();"requestLightProbe"in n&&n.requestLightProbe({reflectionFormat:n.preferredReflectionFormat}).then(l=>{t=new T(this,s,l,o,()=>{i=!0,this.dispatchEvent({type:"estimationstart"})})})}),s.xr.addEventListener("sessionend",()=>{t&&(t.dispose(),t=null),i&&this.dispatchEvent({type:"estimationend"})}),this.dispose=()=>{t&&(t.dispose(),t=null),this.remove(this.lightProbe),this.lightProbe=null,this.remove(this.directionalLight),this.directionalLight=null,this.environment=null}}}let y,a,r,x,A;G();function G(){const p=document.createElement("div");document.body.appendChild(p),a=new S,y=new R(70,window.innerWidth/window.innerHeight,.01,20);const s=new E(16777215,12303359,1);s.position.set(.5,1,.25),a.add(s),r=new P({antialias:!0,alpha:!0}),r.setPixelRatio(window.devicePixelRatio),r.setSize(window.innerWidth,window.innerHeight),r.setAnimationLoop(z),r.xr.enabled=!0,p.appendChild(r.domElement);const o=new C(.3,32,32),t=new W({color:16711680,metalness:1,roughness:.1}),i=new X(o,t);i.position.z=-2,a.add(i);const n=new B(r);n.addEventListener("estimationstart",()=>{a.add(n),a.remove(s),n.environment&&(a.environment=n.environment)}),n.addEventListener("estimationend",()=>{a.add(s),a.remove(n),a.environment=A});const l=document.createElement("button");l.textContent="Start WebXR",document.body.appendChild(M.createButton(r,{optionalFeatures:["light-estimation","hit-test"],domOverlay:{root:l}}));function u(){const c=r.xr.getSession();c&&(c.requestAnimationFrame((e,h)=>{const f=r.xr.getReferenceSpace(),g=h.getViewerPose(f);if(g){const m=g.transform.position;i.matrix.fromArray(g.transform.matrix),console.log("Viewer Position (for gaze/screen inputs):",m)}else console.warn("Viewer pose not available.")}),i.position.set(0,0,-2).applyMatrix4(x.matrixWorld))}x=r.xr.getController(0),x.addEventListener("select",u),a.add(x),window.addEventListener("resize",k)}function k(){y.aspect=window.innerWidth/window.innerHeight,y.updateProjectionMatrix(),r.setSize(window.innerWidth,window.innerHeight)}function z(){r.render(a,y)}
