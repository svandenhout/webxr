import{G as L,L as f,f as w,g as x,S as y,P as v,H as P,W as R,h as E,i as S,M as C,a as W}from"./ARButton-D_SEVJ6B.js";class M{constructor(i,n,r,t,e){this.xrLight=i,this.renderer=n,this.lightProbe=r,this.xrWebGLBinding=null,this.estimationStartCallback=e,this.frameCallback=this.onXRFrame.bind(this);const a=n.xr.getSession();if(t&&"XRWebGLBinding"in window){const g=new x(16);i.environment=g.texture;const h=n.getContext();switch(a.preferredReflectionFormat){case"srgba8":h.getExtension("EXT_sRGB");break;case"rgba16f":h.getExtension("OES_texture_half_float");break}this.xrWebGLBinding=new XRWebGLBinding(a,h),this.lightProbe.addEventListener("reflectionchange",()=>{this.updateReflection()})}a.requestAnimationFrame(this.frameCallback)}updateReflection(){const i=this.renderer.properties.get(this.xrLight.environment);if(i){const n=this.xrWebGLBinding.getReflectionCubeMap(this.lightProbe);n&&(i.__webglTexture=n,this.xrLight.environment.needsPMREMUpdate=!0)}}onXRFrame(i,n){if(!this.xrLight)return;n.session.requestAnimationFrame(this.frameCallback);const t=n.getLightEstimate(this.lightProbe);if(t){this.xrLight.lightProbe.sh.fromArray(t.sphericalHarmonicsCoefficients),this.xrLight.lightProbe.intensity=1;const e=Math.max(1,Math.max(t.primaryLightIntensity.x,Math.max(t.primaryLightIntensity.y,t.primaryLightIntensity.z)));this.xrLight.directionalLight.color.setRGB(t.primaryLightIntensity.x/e,t.primaryLightIntensity.y/e,t.primaryLightIntensity.z/e),this.xrLight.directionalLight.intensity=e,this.xrLight.directionalLight.position.copy(t.primaryLightDirection),this.estimationStartCallback&&(this.estimationStartCallback(),this.estimationStartCallback=null)}}dispose(){this.xrLight=null,this.renderer=null,this.lightProbe=null,this.xrWebGLBinding=null}}class G extends L{constructor(i,n=!0){super(),this.lightProbe=new f,this.lightProbe.intensity=0,this.add(this.lightProbe),this.directionalLight=new w,this.directionalLight.intensity=0,this.add(this.directionalLight),this.environment=null;let r=null,t=!1;i.xr.addEventListener("sessionstart",()=>{const e=i.xr.getSession();"requestLightProbe"in e&&e.requestLightProbe({reflectionFormat:e.preferredReflectionFormat}).then(a=>{r=new M(this,i,a,n,()=>{t=!0,this.dispatchEvent({type:"estimationstart"})})})}),i.xr.addEventListener("sessionend",()=>{r&&(r.dispose(),r=null),t&&this.dispatchEvent({type:"estimationend"})}),this.dispose=()=>{r&&(r.dispose(),r=null),this.remove(this.lightProbe),this.lightProbe=null,this.remove(this.directionalLight),this.directionalLight=null,this.environment=null}}}let c,o,s,d,B;k();function k(){const l=document.createElement("div");document.body.appendChild(l),o=new y,c=new v(70,window.innerWidth/window.innerHeight,.01,20);const i=new P(16777215,12303359,1);i.position.set(.5,1,.25),o.add(i),s=new R({antialias:!0,alpha:!0}),s.setPixelRatio(window.devicePixelRatio),s.setSize(window.innerWidth,window.innerHeight),s.setAnimationLoop(F),s.xr.enabled=!0,l.appendChild(s.domElement);const n=new E(.3,32,32),r=new S({color:16711680,metalness:1,roughness:.1}),t=new C(n,r);t.position.z=-2,o.add(t);const e=new G(s);e.addEventListener("estimationstart",()=>{o.add(e),o.remove(i),e.environment&&(o.environment=e.environment)}),e.addEventListener("estimationend",()=>{o.add(i),o.remove(e),o.environment=B});const a=document.createElement("button");a.textContent="Start WebXR",document.body.appendChild(W.createButton(s,{optionalFeatures:["light-estimation","hit-test"],domOverlay:{root:a}}));function g(){const h=s.xr.getSession();h&&(h.requestAnimationFrame((A,u)=>{const p=s.xr.getReferenceSpace(),m=u.getViewerPose(p);if(m){const b=m.transform.position;t.matrix.fromArray(m.transform.matrix),console.log("Viewer Position (for gaze/screen inputs):",b)}else console.warn("Viewer pose not available.")}),t.position.set(0,0,-2).applyMatrix4(d.matrixWorld))}d=s.xr.getController(0),d.addEventListener("select",g),o.add(d),window.addEventListener("resize",z)}function z(){c.aspect=window.innerWidth/window.innerHeight,c.updateProjectionMatrix(),s.setSize(window.innerWidth,window.innerHeight)}function F(){s.render(o,c)}
