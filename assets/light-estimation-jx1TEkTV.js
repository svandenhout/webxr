import{f as J,g as P,F as H,h as F,L as K,i as q,G as Q,j as Z,k as ee,l as te,S as ie,P as ne,H as re,W as ae,m as oe,n as se,M as le,E as he,a as ce}from"./ARButton-71T4euHb.js";class de extends J{constructor(o){super(o),this.type=P}parse(o){const r=function(e,i){switch(e){case 1:throw new Error("THREE.RGBELoader: Read Error: "+(i||""));case 2:throw new Error("THREE.RGBELoader: Write Error: "+(i||""));case 3:throw new Error("THREE.RGBELoader: Bad File Format: "+(i||""));default:case 4:throw new Error("THREE.RGBELoader: Memory Error: "+(i||""))}},k=`
`,R=function(e,i,a){i=i||1024;let d=e.pos,c=-1,t=0,g="",n=String.fromCharCode.apply(null,new Uint16Array(e.subarray(d,d+128)));for(;0>(c=n.indexOf(k))&&t<i&&d<e.byteLength;)g+=n,t+=n.length,d+=128,n+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(d,d+128)));return-1<c?(e.pos+=t+c+1,g+n.slice(0,c)):!1},C=function(e){const i=/^#\?(\S+)/,a=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,l=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,d=/^\s*FORMAT=(\S+)\s*$/,c=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,t={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};let g,n;for((e.pos>=e.byteLength||!(g=R(e)))&&r(1,"no header found"),(n=g.match(i))||r(3,"bad initial token"),t.valid|=1,t.programtype=n[1],t.string+=g+`
`;g=R(e),g!==!1;){if(t.string+=g+`
`,g.charAt(0)==="#"){t.comments+=g+`
`;continue}if((n=g.match(a))&&(t.gamma=parseFloat(n[1])),(n=g.match(l))&&(t.exposure=parseFloat(n[1])),(n=g.match(d))&&(t.valid|=2,t.format=n[1]),(n=g.match(c))&&(t.valid|=4,t.height=parseInt(n[1],10),t.width=parseInt(n[2],10)),t.valid&2&&t.valid&4)break}return t.valid&2||r(3,"missing format specifier"),t.valid&4||r(3,"missing image size specifier"),t},j=function(e,i,a){const l=i;if(l<8||l>32767||e[0]!==2||e[1]!==2||e[2]&128)return new Uint8Array(e);l!==(e[2]<<8|e[3])&&r(3,"wrong scanline width");const d=new Uint8Array(4*i*a);d.length||r(4,"unable to allocate buffer space");let c=0,t=0;const g=4*l,n=new Uint8Array(4),f=new Uint8Array(g);let N=a;for(;N>0&&t<e.byteLength;){t+4>e.byteLength&&r(1),n[0]=e[t++],n[1]=e[t++],n[2]=e[t++],n[3]=e[t++],(n[0]!=2||n[1]!=2||(n[2]<<8|n[3])!=l)&&r(3,"bad rgbe scanline format");let B=0,E;for(;B<g&&t<e.byteLength;){E=e[t++];const b=E>128;if(b&&(E-=128),(E===0||B+E>g)&&r(3,"bad scanline data"),b){const u=e[t++];for(let X=0;X<E;X++)f[B++]=u}else f.set(e.subarray(t,t+E),B),B+=E,t+=E}const O=l;for(let b=0;b<O;b++){let u=0;d[c]=f[b+u],u+=l,d[c+1]=f[b+u],u+=l,d[c+2]=f[b+u],u+=l,d[c+3]=f[b+u],c+=4}N--}return d},Y=function(e,i,a,l){const d=e[i+3],c=Math.pow(2,d-128)/255;a[l+0]=e[i+0]*c,a[l+1]=e[i+1]*c,a[l+2]=e[i+2]*c,a[l+3]=1},$=function(e,i,a,l){const d=e[i+3],c=Math.pow(2,d-128)/255;a[l+0]=F.toHalfFloat(Math.min(e[i+0]*c,65504)),a[l+1]=F.toHalfFloat(Math.min(e[i+1]*c,65504)),a[l+2]=F.toHalfFloat(Math.min(e[i+2]*c,65504)),a[l+3]=F.toHalfFloat(1)},v=new Uint8Array(o);v.pos=0;const S=C(v),z=S.width,U=S.height,M=j(v.subarray(v.pos),z,U);let T,D,y;switch(this.type){case H:y=M.length/4;const e=new Float32Array(y*4);for(let a=0;a<y;a++)Y(M,a*4,e,a*4);T=e,D=H;break;case P:y=M.length/4;const i=new Uint16Array(y*4);for(let a=0;a<y;a++)$(M,a*4,i,a*4);T=i,D=P;break;default:throw new Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:z,height:U,data:T,header:S.string,gamma:S.gamma,exposure:S.exposure,type:D}}setDataType(o){return this.type=o,this}load(o,m,p,s){function h(r,L){switch(r.type){case H:case P:r.colorSpace=K,r.minFilter=q,r.magFilter=q,r.generateMipmaps=!1,r.flipY=!0;break}m&&m(r,L)}return super.load(o,h,p,s)}}class ge{constructor(o,m,p,s,h){this.xrLight=o,this.renderer=m,this.lightProbe=p,this.xrWebGLBinding=null,this.estimationStartCallback=h,this.frameCallback=this.onXRFrame.bind(this);const r=m.xr.getSession();if(s&&"XRWebGLBinding"in window){const L=new te(16);o.environment=L.texture;const G=m.getContext();switch(r.preferredReflectionFormat){case"srgba8":G.getExtension("EXT_sRGB");break;case"rgba16f":G.getExtension("OES_texture_half_float");break}this.xrWebGLBinding=new XRWebGLBinding(r,G),this.lightProbe.addEventListener("reflectionchange",()=>{this.updateReflection()})}r.requestAnimationFrame(this.frameCallback)}updateReflection(){const o=this.renderer.properties.get(this.xrLight.environment);if(o){const m=this.xrWebGLBinding.getReflectionCubeMap(this.lightProbe);m&&(o.__webglTexture=m,this.xrLight.environment.needsPMREMUpdate=!0)}}onXRFrame(o,m){if(!this.xrLight)return;m.session.requestAnimationFrame(this.frameCallback);const s=m.getLightEstimate(this.lightProbe);if(s){this.xrLight.lightProbe.sh.fromArray(s.sphericalHarmonicsCoefficients),this.xrLight.lightProbe.intensity=1;const h=Math.max(1,Math.max(s.primaryLightIntensity.x,Math.max(s.primaryLightIntensity.y,s.primaryLightIntensity.z)));this.xrLight.directionalLight.color.setRGB(s.primaryLightIntensity.x/h,s.primaryLightIntensity.y/h,s.primaryLightIntensity.z/h),this.xrLight.directionalLight.intensity=h,this.xrLight.directionalLight.position.copy(s.primaryLightDirection),this.estimationStartCallback&&(this.estimationStartCallback(),this.estimationStartCallback=null)}}dispose(){this.xrLight=null,this.renderer=null,this.lightProbe=null,this.xrWebGLBinding=null}}class me extends Q{constructor(o,m=!0){super(),this.lightProbe=new Z,this.lightProbe.intensity=0,this.add(this.lightProbe),this.directionalLight=new ee,this.directionalLight.intensity=0,this.add(this.directionalLight),this.environment=null;let p=null,s=!1;o.xr.addEventListener("sessionstart",()=>{const h=o.xr.getSession();"requestLightProbe"in h&&h.requestLightProbe({reflectionFormat:h.preferredReflectionFormat}).then(r=>{p=new ge(this,o,r,m,()=>{s=!0,this.dispatchEvent({type:"estimationstart"})})})}),o.xr.addEventListener("sessionend",()=>{p&&(p.dispose(),p=null),s&&this.dispatchEvent({type:"estimationend"})}),this.dispose=()=>{p&&(p.dispose(),p=null),this.remove(this.lightProbe),this.lightProbe=null,this.remove(this.directionalLight),this.directionalLight=null,this.environment=null}}}let I,w,_,A,W;pe();function pe(){const x=document.createElement("div");document.body.appendChild(x),w=new ie,I=new ne(70,window.innerWidth/window.innerHeight,.01,20);const o=new re(16777215,12303359,1);o.position.set(.5,1,.25),w.add(o),_=new ae({antialias:!0,alpha:!0}),_.setPixelRatio(window.devicePixelRatio),_.setSize(window.innerWidth,window.innerHeight),_.setAnimationLoop(we),_.xr.enabled=!0,x.appendChild(_.domElement);const m=new oe(.3,32,32),p=new se({color:16711680,metalness:1,roughness:.1}),s=new le(m,p);s.position.z=-2,w.add(s);const h=new me(_);h.addEventListener("estimationstart",()=>{w.add(h),w.remove(o),h.environment&&(w.environment=h.environment)}),h.addEventListener("estimationend",()=>{w.add(o),w.remove(h),w.environment=W}),new de().setPath("textures/equirectangular/").load("royal_esplanade_1k.hdr",function(L){L.mapping=he,W=L,w.environment=W}),document.body.appendChild(ce.createButton(_,{optionalFeatures:["light-estimation","hit-test"]}));function r(){const L=_.xr.getSession();L&&(L.requestAnimationFrame((G,V)=>{const k=_.xr.getReferenceSpace(),R=V.getViewerPose(k);if(R){const C=R.transform.position;s.matrix.fromArray(R.transform.matrix),console.log("Viewer Position (for gaze/screen inputs):",C)}else console.warn("Viewer pose not available.")}),s.position.set(0,0,-2).applyMatrix4(A.matrixWorld))}A=_.xr.getController(0),A.addEventListener("select",r),w.add(A),window.addEventListener("resize",_e)}function _e(){I.aspect=window.innerWidth/window.innerHeight,I.updateProjectionMatrix(),_.setSize(window.innerWidth,window.innerHeight)}function we(){_.render(w,I)}
